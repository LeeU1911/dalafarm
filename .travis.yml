language: go
go:
  - 1.7.1
sudo: required
before_install:
  - chmod +x s3_prod_push.sh
  - pip install --user awscli
  - export PATH=$PATH:$HOME/.local/bin
install:
  - sudo pip install Pygments
  - wget -O /tmp/hugo.deb https://github.com/spf13/hugo/releases/download/v0.21/hugo_0.21_Linux-64bit.deb
  - sudo dpkg -i /tmp/hugo.deb
  - npm install gulp gulp-concat gulp-less gulp-minify-css gulp-rename gulp-uglify gulp-watch
script:
  - hugo version
  - gulp
  - hugo -v
  - ls public
before_deploy: pip install --user s3cmd
deploy:
  provider: script
  skip_cleanup: true
  script: ./s3_prod_push.sh
  on:
    branch: master
after_deploy:
  # Allow `awscli` to make requests to CloudFront.
  - aws configure set preview.cloudfront true
  - aws configure set access_key $AWS_ACCESS_KEY
  - aws configure set secret_key $AWS_SECRET_KEY
  # Invalidate every object in the targeted distribution.
  - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"